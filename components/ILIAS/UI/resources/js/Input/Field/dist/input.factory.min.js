/**
 * This file is part of ILIAS, a powerful learning management system
 * published by ILIAS open source e-Learning e.V.
 *
 * ILIAS is licensed with the GPL-3.0,
 * see https://www.gnu.org/licenses/gpl-3.0.en.html
 * You should have received a copy of said license along with the
 * source code, too.
 *
 * If this is not the case or you just want to try ILIAS, you'll find
 * us at:
 * https://www.ilias.de
 * https://github.com/ILIAS-eLearning
 */
!function(e){"use strict";class t{textarea;remainder=null;constructor(e){if(this.textarea=document.getElementById(e),null===this.textarea)throw new Error(`Could not find textarea for input-id '${e}'.`);if(this.shouldShowRemainder()){if(this.remainder=this.textarea.parentNode.querySelector('[data-action="remainder"]'),!this.remainder instanceof HTMLSpanElement)throw new Error(`Could not find remainder-element for input-id '${e}'.`);this.textarea.addEventListener("input",(()=>{this.updateRemainderCountHook()}))}}updateRemainderCountHook(){this.shouldShowRemainder()&&null!==this.remainder&&(this.remainder.innerHTML=(this.textarea.maxLength-this.textarea.value.length).toString())}updateTextareaContent(e,t=null,i=null){if(!this.isDisabled()){if(this.isContentTooLarge(e))return this.updateRemainderCountHook(),void this.textarea.focus();t=t??this.textarea.selectionStart,i=i??this.textarea.selectionEnd,this.textarea.value=e,t<e.length&&(this.textarea.selectionStart=t),i<e.length&&(this.textarea.selectionEnd=i),this.updateRemainderCountHook(),this.textarea.focus()}}getAbsoluteSelectionStart(){return this.textarea.selectionStart<this.textarea.selectionEnd?this.textarea.selectionStart:this.textarea.selectionEnd}getAbsoluteSelectionEnd(){return this.textarea.selectionStart>this.textarea.selectionEnd?this.textarea.selectionStart:this.textarea.selectionEnd}getLinesBeforeSelection(){return n(this.textarea.value).slice(0,i(this.getTextBeforeSelection()))}getLinesAfterSelection(){const e=n(this.textarea.value);return e.slice(i(this.getTextBeforeSelection()+this.getTextOfSelection())+1,e.length)}getLinesOfSelection(){const e=n(this.textarea.value);return e.slice(this.getLinesBeforeSelection().length,e.length-this.getLinesAfterSelection().length)}isContentTooLarge(e){const t=this.getMaxLength();return!(t<0)&&t<e.length}getTextBeforeSelection(){return this.textarea.value.substring(0,this.getAbsoluteSelectionStart())}getTextAfterSelection(){return this.textarea.value.substring(this.getAbsoluteSelectionEnd(),this.textarea.value.length)}getTextOfSelection(){return this.textarea.value.substring(this.getAbsoluteSelectionStart(),this.getAbsoluteSelectionEnd())}isMultilineTextSelected(){return this.getTextOfSelection().includes("\n")}isTextSelected(){return this.textarea.selectionStart!==this.textarea.selectionEnd}shouldShowRemainder(){return this.getMaxLength()>0}getMaxLength(){return Number(this.textarea.getAttribute("maxlength")??-1)}isDisabled(){return this.textarea.disabled}}function i(e){return(e.match(/\n/g)??[]).length}function n(e){return e.split(/\n/)}class s{instances=[];init(e){if(void 0!==this.instances[e])throw new Error(`Textarea with input-id '${e}' has already been initialized.`);this.instances[e]=new t(e)}get(e){return this.instances[e]??null}}class r{preview_parameter;preview_url;constructor(e,t){this.preview_parameter=e,this.preview_url=t}async getPreviewHtmlOf(e){if(0===e.length)return"";let t=new FormData;return t.append(this.preview_parameter,e),(await fetch(this.preview_url,{method:"POST",body:t})).text()}}const o="textarea",a="preview";class l extends t{preview_history=[];preview_renderer;content_wrappers;view_controls;actions;constructor(e,t){super(t);const i=this.textarea.closest(".c-field-markdown");if(null===i)throw new Error(`Could not find input-wrapper for input-id '${t}'.`);this.preview_renderer=e,this.content_wrappers=function(e){const t=new Map;return t.set(o,e.querySelector("textarea")),t.set(a,e.querySelector(".c-field-markdown__preview")),t.forEach((e=>{if(null===e)throw new Error("Could not find all content-wrappers for markdown-input.")})),t}(i),this.view_controls=function(e){const t=e.querySelector(".il-viewcontrol-mode")?.getElementsByTagName("button");if(!t instanceof HTMLCollection||2!==t.length)throw new Error("Could not find exactly two view-controls.");return[...t]}(i),this.actions=function(e){const t=e.querySelector(".c-field-markdown__actions")?.getElementsByTagName("button");if(t instanceof HTMLCollection)return[...t];return[]}(i);let n=!0;this.textarea.addEventListener("keydown",(e=>{n=this.handleEnterKeyBeforeInsertionHook(e)})),this.textarea.addEventListener("keyup",(e=>{this.handleEnterKeyAfterInsertionHook(e,n)})),this.actions.forEach((e=>{e.addEventListener("click",(e=>{this.performMarkdownActionHook(e)}))})),this.view_controls.forEach((e=>{e.addEventListener("click",(()=>{this.toggleViewingModeHook()}))}))}handleEnterKeyAfterInsertionHook(e,t){if(!t||!d(e))return;const i=this.getLinesBeforeSelection().pop();void 0!==i&&p(i)?this.applyTransformationToSelection(h):void 0!==i&&f(i)&&this.insertSingleEnumeration()}handleEnterKeyBeforeInsertionHook(e){if(!d(e))return!1;const t=this.getLinesOfSelection().shift();if(void 0===t||!((t.match(/((^(\s*-)|(^(\s*\d+\.)))\s*)$/g)??[]).length>0))return!0;let i=this.getLinesBeforeSelection().join("\n"),n=this.getLinesAfterSelection().join("\n");return i.length>0&&(i+="\n"),n.length>0&&(n=`\n${n}`),this.updateTextareaContent(i+n,this.getAbsoluteSelectionStart()-t.length,this.getAbsoluteSelectionEnd()-t.length),e.preventDefault(),!1}performMarkdownActionHook(e){const t=function(e){const t=e.parentNode.closest("span");if(!t instanceof HTMLSpanElement)return null;if(!t.hasAttribute("data-action"))return null;return t.dataset.action}(e.target);switch(t){case"insert-heading":this.insertCharactersAroundSelection("# ","");break;case"insert-link":this.insertCharactersAroundSelection("[","](url)");break;case"insert-bold":this.insertCharactersAroundSelection("**","**");break;case"insert-italic":this.insertCharactersAroundSelection("_","_");break;case"insert-bullet-points":this.applyTransformationToSelection(h);break;case"insert-enumeration":this.isMultilineTextSelected()?this.applyTransformationToSelection(c):this.insertSingleEnumeration();break;default:throw new Error(`Could not perform markdown-action '${t}'.`)}}toggleViewingModeHook(){this.content_wrappers.forEach((e=>{u(e,"hidden")})),this.view_controls.forEach((e=>{u(e,"engaged")})),this.isDisabled()||this.actions.forEach((e=>{e.disabled=!e.disabled;const t=e.querySelector(".glyph");null!==t&&u(t,"disabled")})),this.maybeUpdatePreviewContent()}insertSingleEnumeration(){const e=this.getLinesOfSelection();if(1!==e.length)return void this.textarea.focus();const t=this.getLinesBeforeSelection(),i=t.length-1;let n=i>=0?function(e){const t=e.match(/([0-9]+)/);if(null!==t)return parseInt(t[0]);return null}(t[i])??0:0;const s=c(e,++n),r=function(e,t=0){if(e.length<1)return[];const i=[];for(const n of e){if(!f(n))break;i.push(n.replace(/([0-9]+)/,(++t).toString()))}i.length>0&&(e=i.concat(e.slice(i.length)));return e}(this.getLinesAfterSelection(),n);let o=t.join("\n");const a=r.join("\n");let l=s.join("\n");o.length>0&&l.length>0&&(o+="\n"),l.length>0&&a.length>0&&(l+="\n");const h=o+l+a,u=h.length-this.textarea.value.length;this.updateTextareaContent(h,this.getAbsoluteSelectionStart()+u,this.getAbsoluteSelectionEnd()+u)}applyTransformationToSelection(e){if(!e instanceof Function)throw new Error(`Transformation must be an instance of Function, ${typeof e} given.`);const t=e(this.getLinesOfSelection());if(!t instanceof Array)throw new Error(`Transformation must return an instance of Array, ${typeof t} returned.`);const i=t.length>1;let n=this.getLinesBeforeSelection().join("\n");const s=this.getLinesAfterSelection().join("\n");let r=t.join("\n");n.length>0&&r.length>0&&(n+="\n"),r.length>0&&s.length>0&&(r+="\n");const o=n+r+s,a=o.length-this.textarea.value.length,l=i?n.length:this.getAbsoluteSelectionStart()+a,h=i?l+r.length-1:this.getAbsoluteSelectionEnd()+a;this.updateTextareaContent(o,l,h)}insertCharactersAroundSelection(e,t){const i=this.getTextBeforeSelection()+e+this.getTextOfSelection()+t+this.getTextAfterSelection(),n=this.getAbsoluteSelectionStart()+e.length,s=this.getAbsoluteSelectionEnd()+e.length;this.updateTextareaContent(i,n,s)}maybeUpdatePreviewContent(){const e=this.preview_history[this.preview_history.length-1]??"",t=this.textarea.value;t!==e&&(this.preview_history.push(t),this.preview_renderer.getPreviewHtmlOf(t).then((e=>{this.content_wrappers.get(a).innerHTML=e})))}getBulletPointTransformation(){return h}getEnumerationTransformation(){return c}}function h(e){const t=[],i=!p(e[0]??"");for(const n of e)t.push(i?`- ${n}`:g(n));return t}function c(e,t=1){const i=[],n=!f(e[0]??"");for(const s of e)i.push(n?`${t++}. ${s}`:g(s));return i}function u(e,t){e.classList.contains(t)?e.classList.remove(t):e.classList.add(t)}function d(e){return e instanceof KeyboardEvent&&"Enter"===e.code}function g(e){return e.replace(/((^(\s*[-])|(^(\s*\d+\.)))\s*)/g,"")}function p(e){return(e.match(/^(\s*[-])/g)??[]).length>0}function f(e){return(e.match(/^(\s*\d+\.)/g)??[]).length>0}class x{instances=[];init(e,t,i){if(void 0!==this.instances[e])throw new Error(`Markdown with input-id '${e}' has already been initialized.`);this.instances[e]=new l(new r(i,t),e)}get(e){return this.instances[e]??null}}class S{inputFieldContext;searchbar;selectionComponent;listType;itemList;items;engageDisengageToggle;toggleExpandText;toggleCollapseText;clearSearchButton;scrollContainer;#e;messageNoMatch;constructor(e){this.inputFieldContext=e,this.scrollContainer=this.inputFieldContext.querySelector(".c-input--searchable__field"),this.searchbar=this.inputFieldContext.querySelector(".c-input--searchable__search-input input"),this.listType=this.inputFieldContext.getAttribute("data-il-ui-component"),this.itemList=this.inputFieldContext.querySelector(".c-field--searchable__list"),this.items=this.itemList.querySelectorAll(".c-field--searchable__item"),this.messageNoMatch=this.inputFieldContext.querySelector(".message-no-match"),this.clearSearchButton=this.inputFieldContext.querySelector(".c-input--searchable__clear-search"),this.engageDisengageToggle=this.inputFieldContext.querySelector(".c-input--searchable__visibility-toggle"),this.toggleExpandText=this.engageDisengageToggle.querySelector(".text-expand"),this.toggleCollapseText=this.engageDisengageToggle.querySelector(".text-collapse"),this.isEngaged=!1,this.filterItemsSearch=this.filterItemsSearch.bind(this),this.searchbar.addEventListener("input",this.filterItemsSearch),this.clearSearchButton.addEventListener("click",(()=>{this.isFiltered=!1})),this.toggleVisibility=this.toggleVisibility.bind(this),this.engageDisengageToggle.addEventListener("click",this.toggleVisibility),"radio-field-input"===this.listType&&(this.scrollListToTop=this.scrollListToTop.bind(this),this.items.forEach((e=>{e.addEventListener("change",this.scrollListToTop)})))}get isFiltered(){return this.#e}set isFiltered(e){this.#e!==e&&(this.#e=e,e?this.clearSearchButton.style.removeProperty("display"):(this.searchbar.value="",this.clearSearchButton.style.display="none",this.messageNoMatch.style.display="none",this.resetItemsDisplay()))}toggleVisibility(){this.isEngaged?(this.isEngaged=!1,this.inputFieldContext.classList.remove("engaged"),this.isFiltered=!1,this.engageDisengageToggle.setAttribute("aria-expanded","false"),this.toggleExpandText.style.removeProperty("display"),this.toggleCollapseText.style.display="none"):(this.isEngaged=!0,this.inputFieldContext.classList.add("engaged"),this.engageDisengageToggle.setAttribute("aria-expanded","true"),this.toggleExpandText.style.display="none",this.toggleCollapseText.style.removeProperty("display"))}filterItemsSearch(e){const t=e.target.value.toLowerCase();this.isFiltered=!!t;let i=!1;this.items.forEach((e=>{e.textContent.toLowerCase().includes(t)?(i=!0,m(e)):function(e){e.style.display="none"}(e)})),""!==t&&!1===i?this.messageNoMatch.style.removeProperty("display"):(""===t||i)&&(this.messageNoMatch.style.display="none")}resetItemsDisplay(){this.items.forEach((e=>m(e)))}scrollListToTop(){this.scrollContainer.scrollTo({top:0,behavior:"smooth"})}}function m(e){e.style.removeProperty("display")}class w{instances=[];init(e){if(void 0!==this.instances[e.id])throw new Error(`A searchable field with input-id '${e.id}' has already been initialized.`);this.instances[e.id]=new S(e)}get(e){return this.instances[e]??null}}var y;e.UI=e.UI||{},e.UI.Input=e.UI.Input||{},(y=e.UI.Input).textarea=new s,y.markdown=new x,y.searchableinputcontext=new w}(il);
