/**
 * This file is part of ILIAS, a powerful learning management system
 * published by ILIAS open source e-Learning e.V.
 *
 * ILIAS is licensed with the GPL-3.0,
 * see https://www.gnu.org/licenses/gpl-3.0.en.html
 * You should have received a copy of said license along with the
 * source code, too.
 *
 * If this is not the case or you just want to try ILIAS, you'll find
 * us at:
 * https://www.ilias.de
 * https://github.com/ILIAS-eLearning
 */
!function(e,t,n){"use strict";class r{textarea;remainder=null;constructor(e){if(this.textarea=document.getElementById(e),null===this.textarea)throw new Error(`Could not find textarea for input-id '${e}'.`);if(this.shouldShowRemainder()){if(this.remainder=this.textarea.parentNode.querySelector('[data-action="remainder"]'),!this.remainder instanceof HTMLSpanElement)throw new Error(`Could not find remainder-element for input-id '${e}'.`);this.textarea.addEventListener("input",(()=>{this.updateRemainderCountHook()}))}}updateRemainderCountHook(){this.shouldShowRemainder()&&null!==this.remainder&&(this.remainder.innerHTML=(this.textarea.maxLength-this.textarea.value.length).toString())}updateTextareaContent(e,t=null,n=null){if(!this.isDisabled()){if(this.isContentTooLarge(e))return this.updateRemainderCountHook(),void this.textarea.focus();t=t??this.textarea.selectionStart,n=n??this.textarea.selectionEnd,this.textarea.value=e,t<e.length&&(this.textarea.selectionStart=t),n<e.length&&(this.textarea.selectionEnd=n),this.updateRemainderCountHook(),this.textarea.focus()}}getAbsoluteSelectionStart(){return this.textarea.selectionStart<this.textarea.selectionEnd?this.textarea.selectionStart:this.textarea.selectionEnd}getAbsoluteSelectionEnd(){return this.textarea.selectionStart>this.textarea.selectionEnd?this.textarea.selectionStart:this.textarea.selectionEnd}getLinesBeforeSelection(){return o(this.textarea.value).slice(0,i(this.getTextBeforeSelection()))}getLinesAfterSelection(){const e=o(this.textarea.value);return e.slice(i(this.getTextBeforeSelection()+this.getTextOfSelection())+1,e.length)}getLinesOfSelection(){const e=o(this.textarea.value);return e.slice(this.getLinesBeforeSelection().length,e.length-this.getLinesAfterSelection().length)}isContentTooLarge(e){const t=this.getMaxLength();return!(t<0)&&t<e.length}getTextBeforeSelection(){return this.textarea.value.substring(0,this.getAbsoluteSelectionStart())}getTextAfterSelection(){return this.textarea.value.substring(this.getAbsoluteSelectionEnd(),this.textarea.value.length)}getTextOfSelection(){return this.textarea.value.substring(this.getAbsoluteSelectionStart(),this.getAbsoluteSelectionEnd())}isMultilineTextSelected(){return this.getTextOfSelection().includes("\n")}isTextSelected(){return this.textarea.selectionStart!==this.textarea.selectionEnd}shouldShowRemainder(){return this.getMaxLength()>0}getMaxLength(){return Number(this.textarea.getAttribute("maxlength")??-1)}isDisabled(){return this.textarea.disabled}}function i(e){return(e.match(/\n/g)??[]).length}function o(e){return e.split(/\n/)}class l{instances=[];init(e){if(void 0!==this.instances[e])throw new Error(`Textarea with input-id '${e}' has already been initialized.`);this.instances[e]=new r(e)}get(e){return this.instances[e]??null}}class s{preview_parameter;preview_url;constructor(e,t){this.preview_parameter=e,this.preview_url=t}async getPreviewHtmlOf(e){if(0===e.length)return"";let t=new FormData;return t.append(this.preview_parameter,e),(await fetch(this.preview_url,{method:"POST",body:t})).text()}}const a="textarea",c="preview";class d extends r{preview_history=[];preview_renderer;content_wrappers;view_controls;actions;constructor(e,t){super(t);const n=this.textarea.closest(".c-field-markdown");if(null===n)throw new Error(`Could not find input-wrapper for input-id '${t}'.`);this.preview_renderer=e,this.content_wrappers=function(e){const t=new Map;return t.set(a,e.querySelector("textarea")),t.set(c,e.querySelector(".c-field-markdown__preview")),t.forEach((e=>{if(null===e)throw new Error("Could not find all content-wrappers for markdown-input.")})),t}(n),this.view_controls=function(e){const t=e.querySelector(".il-viewcontrol-mode")?.getElementsByTagName("button");if(!t instanceof HTMLCollection||2!==t.length)throw new Error("Could not find exactly two view-controls.");return[...t]}(n),this.actions=function(e){const t=e.querySelector(".c-field-markdown__actions")?.getElementsByTagName("button");if(t instanceof HTMLCollection)return[...t];return[]}(n);let r=!0;this.textarea.addEventListener("keydown",(e=>{r=this.handleEnterKeyBeforeInsertionHook(e)})),this.textarea.addEventListener("keyup",(e=>{this.handleEnterKeyAfterInsertionHook(e,r)})),this.actions.forEach((e=>{e.addEventListener("click",(e=>{this.performMarkdownActionHook(e)}))})),this.view_controls.forEach((e=>{e.addEventListener("click",(()=>{this.toggleViewingModeHook()}))}))}handleEnterKeyAfterInsertionHook(e,t){if(!t||!f(e))return;const n=this.getLinesBeforeSelection().pop();void 0!==n&&S(n)?this.applyTransformationToSelection(u):void 0!==n&&p(n)&&this.insertSingleEnumeration()}handleEnterKeyBeforeInsertionHook(e){if(!f(e))return!1;const t=this.getLinesOfSelection().shift();if(void 0===t||!((t.match(/((^(\s*-)|(^(\s*\d+\.)))\s*)$/g)??[]).length>0))return!0;let n=this.getLinesBeforeSelection().join("\n"),r=this.getLinesAfterSelection().join("\n");return n.length>0&&(n+="\n"),r.length>0&&(r=`\n${r}`),this.updateTextareaContent(n+r,this.getAbsoluteSelectionStart()-t.length,this.getAbsoluteSelectionEnd()-t.length),e.preventDefault(),!1}performMarkdownActionHook(e){const t=function(e){const t=e.parentNode.closest("span");if(!t instanceof HTMLSpanElement)return null;if(!t.hasAttribute("data-action"))return null;return t.dataset.action}(e.target);switch(t){case"insert-heading":this.insertCharactersAroundSelection("# ","");break;case"insert-link":this.insertCharactersAroundSelection("[","](url)");break;case"insert-bold":this.insertCharactersAroundSelection("**","**");break;case"insert-italic":this.insertCharactersAroundSelection("_","_");break;case"insert-bullet-points":this.applyTransformationToSelection(u);break;case"insert-enumeration":this.isMultilineTextSelected()?this.applyTransformationToSelection(h):this.insertSingleEnumeration();break;default:throw new Error(`Could not perform markdown-action '${t}'.`)}}toggleViewingModeHook(){this.content_wrappers.forEach((e=>{g(e,"hidden")})),this.view_controls.forEach((e=>{g(e,"engaged")})),this.isDisabled()||this.actions.forEach((e=>{e.disabled=!e.disabled;const t=e.querySelector(".glyph");null!==t&&g(t,"disabled")})),this.maybeUpdatePreviewContent()}insertSingleEnumeration(){const e=this.getLinesOfSelection();if(1!==e.length)return void this.textarea.focus();const t=this.getLinesBeforeSelection(),n=t.length-1;let r=n>=0?function(e){const t=e.match(/([0-9]+)/);if(null!==t)return parseInt(t[0]);return null}(t[n])??0:0;const i=h(e,++r),o=function(e,t=0){if(e.length<1)return[];const n=[];for(const r of e){if(!p(r))break;n.push(r.replace(/([0-9]+)/,(++t).toString()))}n.length>0&&(e=n.concat(e.slice(n.length)));return e}(this.getLinesAfterSelection(),r);let l=t.join("\n");const s=o.join("\n");let a=i.join("\n");l.length>0&&a.length>0&&(l+="\n"),a.length>0&&s.length>0&&(a+="\n");const c=l+a+s,d=c.length-this.textarea.value.length;this.updateTextareaContent(c,this.getAbsoluteSelectionStart()+d,this.getAbsoluteSelectionEnd()+d)}applyTransformationToSelection(e){if(!e instanceof Function)throw new Error(`Transformation must be an instance of Function, ${typeof e} given.`);const t=e(this.getLinesOfSelection());if(!t instanceof Array)throw new Error(`Transformation must return an instance of Array, ${typeof t} returned.`);const n=t.length>1;let r=this.getLinesBeforeSelection().join("\n");const i=this.getLinesAfterSelection().join("\n");let o=t.join("\n");r.length>0&&o.length>0&&(r+="\n"),o.length>0&&i.length>0&&(o+="\n");const l=r+o+i,s=l.length-this.textarea.value.length,a=n?r.length:this.getAbsoluteSelectionStart()+s,c=n?a+o.length-1:this.getAbsoluteSelectionEnd()+s;this.updateTextareaContent(l,a,c)}insertCharactersAroundSelection(e,t){const n=this.getTextBeforeSelection()+e+this.getTextOfSelection()+t+this.getTextAfterSelection(),r=this.getAbsoluteSelectionStart()+e.length,i=this.getAbsoluteSelectionEnd()+e.length;this.updateTextareaContent(n,r,i)}maybeUpdatePreviewContent(){const e=this.preview_history[this.preview_history.length-1]??"",t=this.textarea.value;t!==e&&(this.preview_history.push(t),this.preview_renderer.getPreviewHtmlOf(t).then((e=>{this.content_wrappers.get(c).innerHTML=e})))}getBulletPointTransformation(){return u}getEnumerationTransformation(){return h}}function u(e){const t=[],n=!S(e[0]??"");for(const r of e)t.push(n?`- ${r}`:m(r));return t}function h(e,t=1){const n=[],r=!p(e[0]??"");for(const i of e)n.push(r?`${t++}. ${i}`:m(i));return n}function g(e,t){e.classList.contains(t)?e.classList.remove(t):e.classList.add(t)}function f(e){return e instanceof KeyboardEvent&&"Enter"===e.code}function m(e){return e.replace(/((^(\s*[-])|(^(\s*\d+\.)))\s*)/g,"")}function S(e){return(e.match(/^(\s*[-])/g)??[]).length>0}function p(e){return(e.match(/^(\s*\d+\.)/g)??[]).length>0}class w{instances=[];init(e,t,n){if(void 0!==this.instances[e])throw new Error(`Markdown with input-id '${e}' has already been initialized.`);this.instances[e]=new d(new s(n,t),e)}get(e){return this.instances[e]??null}}class b{constructor(e,t,n,r,i,o=null,l=null,s=null){this.id=e,this.name=t,this.element=n,this.selectButton=r,this.drilldownParentLevel=i,this.drilldownButton=o,this.listElement=l,this.renderUrl=s}}function E(e){return!e.classList.contains("c-input-node__leaf")&&e.classList.contains("c-input-node")}function y(e,t=null){return e.reduce(((e,t)=>{const n=function(e){const t=e.getAttribute("data-node-id");if(null===t)throw new Error("Could not find data-node-id attribute.");return t}(t);if(e.has(n))throw new Error(`Node '${n}' has already been parsed. There might be a rendering issue.`);return e.set(n,new b(n,function(e){const t=e.querySelector("[data-node-name]");if(null===t)throw new Error("Could not find element with data-node-name attribute.");return t.textContent}(t),t,function(e){const t=e.querySelector(":scope > .c-input-node__select");if(null===t)throw new Error("Could not find node select button.");return t}(t),function(e){const t=e.closest("ul[data-ddindex]");if(null===t)throw new Error("Could not find drilldown menu of node.");return t.getAttribute("data-ddindex")}(t),function(e){if(!E(e))return null;const t=e.querySelector(".c-drilldown__menulevel--trigger");if(null===t)throw new Error("Could not find drilldown menu button of branch node.");return t}(t),function(e){if(!E(e))return null;const t=e.querySelector("ul");if(null===t)throw new Error("Could not find list element of branch node.");return t}(t),function(e){return function(e){return e.classList.contains("c-input-node__async")}(e)&&e.hasAttribute("data-render-url")?e.getAttribute("data-render-url"):null}(t)))}),new Map(t??[]))}function v(e,t){for(let n=0;n<e.length;n+=1)t(e[n],n)}function x(e,t){e.classList.toggle("c-input-node--selected",t)}function A(e){return Array.from(e.querySelectorAll(".c-input-node"))}class L{#e=new Set;#t=new Set;#n=new Set;#r;#i;#o;#l;#s;#a;#c;#d;#u;#h;#g;#f;#m;constructor(e,t,n,r,i,o,l,s,a,c,d,u,h){this.#r=t,this.#i=n,this.#o=r,this.#l=i,this.#s=o,this.#a=l,this.#c=s,this.#d=a,this.#u=c,this.#h=d,this.#g=u,this.#f=h,this.#m=y(A(u)),e.on(this.#g.ownerDocument,this.#l.getBackSignal(),(()=>{this.#S()})),this.#g.querySelectorAll('[data-action="close"]').forEach((e=>{e.addEventListener("click",(()=>{this.#p()}))})),this.#c.querySelectorAll("li").forEach((e=>{const t=function(e){const t=e.getAttribute("data-node-id");if(null===t)throw new Error("Could not find 'data-node-id' attribbute of element.");return t}(e);this.#w(e,t),this.#b(t)})),this.#l.addEngageListener((e=>{this.#E(e)})),this.#h.addEventListener("click",(()=>{this.#y()})),this.#m.forEach((e=>{this.#v(e)})),this.#x()}async#A(e){var t,n;if(!this.#t.has(e.id)&&!this.#n.has(e.id))try{this.#n.add(e.id);const r=await this.#i.loadContent(e.renderUrl);e.listElement.append(...r.children),this.#l.parseLevels();const i=y(A(e.listElement),this.#m),o=(t=i,n=this.#m,Array.from(t.entries()).filter((([e])=>!n.has(e))).map((([,e])=>e)));this.#m=i,v(o,(e=>{this.#e.has(e.id)?this.#L(e.id):this.#C(e.id),this.#v(e)})),this.#t.add(e.id)}catch(e){throw new Error(`Could not render async node children: ${e.message}`)}finally{this.#n.delete(e.id)}}#B(e){this.#T(),v(function(e,t,n=255){const r=[];let i=e;for(let e=0;e<n;e+=1){const e=i.closest(t);if(!e||!e.parentElement)break;i=e.parentElement,r.push(e)}return r.reverse()}(e.element,".c-input-node"),(e=>{const t=e.getAttribute("data-node-id");if(null===t||!this.#m.has(t))throw new Error("Could not find 'data-node-id' of node element.");const n=this.#m.get(t);this.#q(n)}))}#q(e){const t=this.#r.createContent(this.#a).querySelector(".crumb");t.setAttribute("data-ddindex",e.drilldownParentLevel),t.firstElementChild.textContent=e.name,t.addEventListener("click",(()=>{this.#l.engageLevel(e.drilldownParentLevel),e.drilldownButton.click()})),this.#s.append(t)}#S(){const e=this.#s.querySelectorAll(".crumb");e.item(e.length-1)?.remove()}#T(){v(this.#s.querySelectorAll(".crumb"),(e=>{e.remove()}))}#E(e){if("0"===e)return void this.#T();const t=this.#g.querySelector(`ul[data-ddindex="${e}"]`)?.closest(".c-input-node")?.getAttribute("data-node-id");if(null===t||!this.#m.has(t))throw new Error(`Could not find node for drilldown-level '${e}'.`);this.#B(this.#m.get(t))}#k(e,t){e.addEventListener("click",(()=>{null!==t.renderUrl&&this.#A(t)}))}#w(e,t){e.querySelector('[data-action="remove"]')?.addEventListener("click",(()=>{this.#C(t),e.remove()}))}#_(e,t){e.addEventListener("click",(()=>{this.#e.has(t.id)?this.#C(t.id):this.#L(t.id)}))}#M(e){if(null!==this.#c.querySelector(`li[data-node-id="${e.id}"]`))return;const t=this.#r.createContent(this.#d),n=t.querySelector("[data-node-id]");n.setAttribute("data-node-id",e.id),n.querySelector("[data-node-name]").textContent=e.name,n.querySelector("input").value=e.id,this.#w(n,e.id),this.#c.append(...t.children)}#N(e){this.#c.querySelector(`li[data-node-id="${e}"]`)?.remove()}#C(e){if(this.#H(e),this.#x(),this.#N(e),this.#m.has(e)){const t=this.#m.get(e);x(t.element,!1),this.#$(t.selectButton),this.#f(this.#m,this.#e)}}#L(e){if(this.#b(e),this.#x(),this.#m.has(e)){const t=this.#m.get(e);x(t.element,!0),this.#D(t.selectButton),this.#f(this.#m,this.#e),this.#M(t)}}#v(e){this.#_(e.selectButton,e),null!==e.drilldownButton&&this.#k(e.drilldownButton,e)}#$(e){e.querySelector('[data-action="remove"]')?.classList.add("hidden"),e.querySelector('[data-action="select"]')?.classList.remove("hidden"),e.setAttribute("aria-label",this.#R("select_node"))}#D(e){e.querySelector('[data-action="select"]')?.classList.add("hidden"),e.querySelector('[data-action="remove"]')?.classList.remove("hidden"),e.setAttribute("aria-label",this.#R("unselect_node"))}#x(){this.#u.disabled=this.#e.size<=0}#H(e){this.#e.has(e)&&this.#e.delete(e)}#b(e){this.#e.has(e)||this.#e.add(e)}#R(e){return this.#o?.txt(e)??t.Language.txt(e)}#p(){this.#g.close()}#y(){this.#g.showModal()}}function C(e,t){const n=e.createDocumentFragment();return n.append(...t),n}function B(e,t,n){e.querySelectorAll(`[${n}]`).forEach((e=>{const r=e.getAttribute(n);if(!t.has(r))throw new Error(`Element references '${r}' which does not exist.`);e.setAttribute(n,t.get(r))}))}class T{#I;constructor(e){this.#I=e}createContent(e){const t=e.content.cloneNode(!0),n=new Map;return t.querySelectorAll("[id]").forEach((e=>{const t=function(e=""){return`${e}${Date.now().toString(36)}_${Math.random().toString(36).substring(2)}`}("il_ui_fw_");n.set(e.id,t),e.id=t})),t.querySelectorAll("[for]").forEach((e=>{e.htmlFor=n.get(e.htmlFor)})),B(t,n,"aria-describedby"),B(t,n,"aria-labelledby"),B(t,n,"aria-controls"),B(t,n,"aria-owns"),C(this.#I,t.children)}}class q{#I;constructor(e){this.#I=e}loadContent(e){return fetch(e.toString()).then((e=>e.text())).then((e=>this.#U(e))).then((e=>C(this.#I,e))).catch((t=>{throw new Error(`Could not render element(s) from '${e}': ${t.message}`)}))}#j(e){const t=this.#I.createElement("script");return e.hasAttribute("type")&&t.setAttribute("type",e.getAttribute("type")),e.hasAttribute("src")&&t.setAttribute("src",e.getAttribute("src")),e.textContent.length>0&&(t.textContent=e.textContent),t}#U(e){const t=this.#I.createElement("div");return t.innerHTML=e.trim(),t.querySelectorAll("script").forEach((e=>{const t=this.#j(e);e.replaceWith(t)})),t.children}}function k(e,t){e.forEach(((e,n)=>{t.size>0?(e.selectButton.disabled=!t.has(n),e.selectButton.querySelector(".glyph").classList.toggle("disabled",!t.has(n))):(e.selectButton.disabled=!1,e.selectButton.querySelector(".glyph").classList.toggle("disabled",!1))}))}function _(e,t){e.forEach((e=>{e.selectButton.disabled=!1,e.selectButton.querySelector(".glyph").classList.remove("disabled")})),t.forEach((t=>{const n=e.get(t);if(null===n)throw new Error(`Could not toggle availability of node '${t}'.`);null!==n.listElement&&n.listElement.querySelectorAll(".c-input-node__select").forEach((e=>{e.disabled=!0,e.querySelector(".glyph").classList.add("disabled")}))}))}class M{#O=new Map;#F;#P;#o;#I;constructor(e,t,n,r){this.#F=e,this.#P=t,this.#o=n,this.#I=r}initTreeMultiSelect(e,t){t?this.#K(e,(()=>{})):this.#K(e,_)}initTreeSelect(e){this.#K(e,k)}#K(e,t){if(this.#O.has(e))throw new Error(`TreeSelect '${e}' already exists.`);const n=this.#I.getElementById(e),r=n?.closest(".c-input-tree_select"),i=r?.querySelector(".breadcrumb"),o=r?.querySelector(".modal-body > template"),l=r?.querySelector(".c-input-tree_select__selection"),s=l?.querySelector(":scope > template"),a=r?.querySelector("dialog"),c=a?.querySelector(".btn-primary");if(null===i||null===o||null===l||null===s||null===c||null===n||null===a)throw new Error(`Could not find some element(s) for Tree Select Input '${e}'.`);const d=this.#z(r),u=new L(this.#F,new T(this.#I),new q(this.#I),this.#o,d,i,o,l,s,c,n,a,t);this.#O.set(e,u)}getInstance(e){return this.#O.has(e)?this.#O.get(e):null}#z(e){const t=e.querySelector(".c-drilldown");if(null===t||!t.hasAttribute("id"))throw new Error("Could not find drilldown element.");const n=this.#P.getInstance(t.id);if(null===t)throw new Error("Could not find drilldown instance.");return n}}class N{#Q;constructor(e){this.#Q=e}on(e,t,n){this.#Q(e).on(t,n)}off(e,t,n){this.#Q(e).off(t,n)}}var H;t.UI=t.UI||{},t.UI.Input=t.UI.Input||{},(H=t.UI.Input).textarea=new l,H.markdown=new w,H.treeSelect=new M(new N(e),t.UI.menu.drilldown,t.Language,n)}($,il,document);
